<!-- chart -->
<script type="text/javascript">
    function onButtonChange(b){
        console.log("Button/Slider changed", b);
        var btn = {};
        btn.type = b.type === "checkbox" ? 0 : 1;
        btn.name = b.getAttribute("id");
        if(btn.type === 0){
            btn.value = b.checked ? 1 : 0;
        } else if(btn.type === 1){
            btn.value = parseInt(b.value);
        }
        console.log("new value", btn);
        // POST JSON config
        $.post( "/button/change", btn, function( data ) {
            console.log(data);
        }).done(function(s) {
            console.log("done");
        })
        .fail(function(e) {
            console.log("error ", e);
        });
    }

    function zip(arr1, arr2){
        var res = []
        for(var i=0; i<arr1.length; i++){
            res.push([arr1[i], arr2[i]]);
        }
        return res
    }

    function loadChartData(options){
        // Load data asynchronously using jQuery. On success, add the data
        // to the options and initiate the chart.
        // This data is obtained by exporting a GA custom report to TSV.
        // http://api.jquery.com/jQuery.get/
        console.log("loading chart data...");
        jQuery.get("/sensordata.json", function (json) {
            console.log("got chart data:", json);
            // convert seconds to milliseconds
            json.time = json.time.map(function(x) { return x * 1000; });
            
            // clear data
            options.series = [];

            // set new data
            json.sensors.forEach(s => {
                if(s.hasOwnProperty("temperature")){
                    //console.log(zip(json.time, s.temperature));
                    options.series.push({
                        "data": zip(json.time, s.temperature),
                        "name": s.name + " temperature",
                        "color": "#ff0000"
                    });
                }
                if(s.hasOwnProperty("humidity")){
                    options.series.push({
                        "data": zip(json.time, s.humidity),
                        "name": s.name + " humidity",
                        "color": "#0000ff"
                    });
                }
            });

            // add thresholds
            options.yAxis.plotLines = []
            json.thresholds.forEach(thresh => {
                options.yAxis.plotLines.push({
                        color: 'gray', // Color value
                        dashStyle: 'dot', // Style of the plot line. Default to solid
                        value: thresh.threshold, // Value of where the line will appear
                        width: 2, // Width of the line
                        label: {
                            text: thresh.name, // Content of the label.
                            //align: 'left', // Positioning of the label.
                            color: 'gray',
                        }
                    });
            });

            // add events
            json.events.forEach(e => {
                // Add flags for important milestones. This requires Highstock.
                if (Highcharts.seriesTypes.flags) {
                    options.series.push({
                        type: 'flags',
                        name: e.name,
                        color: '#333333',
                        shape: 'squarepin',
                        y: -80,
                        data: [
                            { x: e.time*1000, text: e.description, title: e.name, shape: 'squarepin' }
                        ],
                        showInLegend: false
                    });
                }
            });

            setTimeout(loadChartData, 60000, options);

            return new Highcharts.Chart(options);
        });
    }

    $(function () {
        var chart;
        $(document).ready(function () {
            // define the options
            var options = {
                chart: {
                    renderTo: 'container',
                    zoomType: 'x',
                    type: 'spline'
                },
                title: {
                    text: 'TerraESP'
                },
                subtitle: {
                    text: 'Click and drag in the plot area to zoom in'
                },
                xAxis: {
                    type: 'datetime',
                },
                yAxis: {
                    title: {
                        text: 'C'
                    },
                    plotLines: []
                    //startOnTick: false,
                    //showFirstLabel: false
                },
                legend: {
                    enabled: true
                },
                plotOptions: {
                    series: {
                        cursor: 'pointer',
                        lineWidth: 1.0
                    }
                },
                series: [],
                // series: [{
                //     name: 'Temperature',
                //     color: '#ff0000',
                //     marker: {
                //         radius: 2
                //     }
                // },
                //     {
                //         name: 'Humid',
                //         color: '#0000ff',
                //         marker: {
                //             radius: 2
                //         }
                //     }]
            };


            // load buttons, then load sensordata
            jQuery.get("/buttons.json", function (buttons) {
                console.log("got buttons", buttons);
                buttons.forEach(function(b) {
                    console.log(b);
                    $("#buttons").append("<div style='margin: 5px;' class='btn-group' data-toggle='buttons'>");
                    if(b.type === 0){ // toggle
                        $("#buttons")
                            .append("<label class='btn btn-secondary "+ (b.state ? "checked" : "") +"'>" +
                                "<input type='checkbox' "+ (b.state ? "checked " : "") +
                                "id ='"+b.name+"'autocomplete='off' onchange='onButtonChange(this)'>" +
                                b.name +
                                "</label>");
                    } else {
                        $("#buttons")
                            .append(b.name + " <input type='range' min='"+b.min+"' " +
                                "max='"+b.max+"' value='"+b.state+"' id='"+b.name+"'" +
                                "onchange='onButtonChange(this)'>");
                    }
                    $("#buttons").append("</div>");
                });

                // load sensordata
                chart = loadChartData(options);
            });
        });
    });
</script>

<h1>Home</h1>
<div id="buttons"></div>
<div id="container" style="min-width: 400px; height: 400px; margin: 0 auto"></div>
